---
title: "Project-3"
author: "Hannes"
date: "21.03.2023"
output: bookdown::html_document2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

# Introduction

In this report we will analyze data containing all the football games with results from the English premier league (EPL) seasons 18/19, 19/20, 20/21 and 21/22. In the 20/21 season no fans were allowed to the stadiums because of the Covid-19 pandemic. Accordingly in the following sections we will use the circumstance of no fans being allowed to the EPL stadiums to determine whether the home effect reduced during Covid and analyze the development after Covid. For our analysis we quantify the home effect as the expected number of goals from the home team and will try to answer the above questions by modelling the data using poisson regression.

# Data exploration

After removing the variables not related to our question of the home effect from our data, we have the following variables available.

* `date` Date when the match was played.
* `home_team` Name of the home team in the match.
* `away_team` Name of the away team in the match.
* `fulltime_home_goals` Number of goals of the home team.
* `fulltime_away_goals` Number of goals of the away team.

```{r dataprep}
library("tidyverse") 
library("knitr") # for tables
library("car") # for type 2 anova
data_18_19 = read.csv(file = "Data/season-1819.csv")
data_19_20 = read.csv(file = "Data/2019-20.csv")
data_20_21 = read.csv(file = "Data/2020-2021.csv")
data_21_22 = read.csv(file = "Data/2021-2022.csv")

# add coloumn if match was pre covid (0) or during covid (1) or post covid (2)
fans_18_19 = rep(0, nrow(data_18_19))
fans_19_20 = rep(0, nrow(data_19_20))
fans_20_21 = rep(1, nrow(data_20_21))
fans_21_22 = rep(2, nrow(data_21_22))
data_18_19 = data_18_19 %>% mutate(covid = fans_18_19)
data_19_20 = data_19_20 %>% mutate(covid = fans_19_20)
data_20_21 = data_20_21 %>% mutate(covid = fans_20_21)
data_21_22 = data_21_22 %>% mutate(covid = fans_21_22)

# extract fulltime results for later
fulltime_result = c(data_18_19$FTR, data_19_20$FTR, 
                        data_20_21$FTR, data_20_21$FTR)

# extract useful variables for us
data_18_19 = data_18_19 %>%
  select(HomeTeam, AwayTeam, FTHG, FTAG, covid)
data_19_20 = data_19_20 %>%
  select(HomeTeam, AwayTeam, FTHG, FTAG, covid)
data_20_21 = data_20_21 %>%
  select(HomeTeam, AwayTeam, FTHG, FTAG, covid)
data_21_22 = data_21_22 %>%
  select(HomeTeam, AwayTeam, FTHG, FTAG, covid)

# merge all seasons together to a whole dataset
data = rbind(data_18_19, data_19_20, data_20_21, data_21_22)
# change character variables to factor except Date
data = data %>% 
  mutate_if(is.character, as.factor) %>%
  mutate(covid = as.factor(covid))
```

```{r renames}
# rename to snake_case and more understandable names
data = data %>%
  rename(home_team = HomeTeam, away_team = AwayTeam, 
         fulltime_home_goals = FTHG, fulltime_away_goals = FTAG)
```
First, we convert the variable `date` to the factor variable `covid` with levels 0 (pre-covid, 18/19 and 19/20 seasons), 1 (covid, 20/21 season) and 2 (post-covid, 21/22 season). Using the information from these variables, we create a table with the full time result (home win, draw or away win) and the time frame (pre covid, covid and post covid) to visually deduce if there could be an effect or not.

```{r exploretable}
tab = table(fulltime_result, data$covid)
data_tab = as.data.frame(tab)
rownames(tab) = c("away win", "draw", "home win")
colnames(tab) = c("pre-covid", "covid", "post-covid")
names(data_tab) = c("winner", "covid", "freq")
gm_1 = glm(freq ~ ., data = data_tab, family=poisson(link="log"))
kable(tab, caption = "Contingency table showing the distribution of home win, 
      draw, and away win outcomes before, during, and after the COVID-19 pandemic.")
#Anova(gm_1, type = 2, test = "LR")
```

Note that for our analysis we do not only consider the home effect using the match result but by the exact number of home goals scored. Still, table (\@ref(tab:exploretable)) indicates that there might be a change in the home effect during covid and it makes sense to pursue further analysis.

# Poisson regression to analyze the home effect

In this section fit a poisson regression model with the number of goals scored of one team in a match as a response. Therefore we need to change the structure of our dataset because currently in each observation (1 game) we have the information about homegoals and awaygoals. So we create a dataframe such that each match is coded up twice, once from the hometeam perspective indicating how many times the home team scored in that match and once from the awayteam perspective indicating how many times the away team scored in that match. So we include a binary variable called "home" indicating if the goals scored are from the hometeam (1) or from the awayteam (0). So next to the factors "hometeam", "awayteam" and "home" we also include a "covid" factor as predictors for the goals scored.

## Quantify the home effect before covid

## Development of home effect during covid

Try to answer the following questions

* Did the home effect reduce during Covid?
* What is the development of the home effect after Covid?





